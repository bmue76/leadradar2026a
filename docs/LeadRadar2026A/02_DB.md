# 02_DB — Datenmodell & Migrations (LeadRadar2026A)

Stand: 2025-12-31

## Grundsätze (verbindlich)

- **Tenant-first / leak-safe:** Jede tenant-owned Entity hat ein Pflichtfeld `tenantId`.
  - Lookups später immer `{ id, tenantId }` bzw. `findFirst({ where: { id, tenantId } })`.
  - Bei Scope mismatch: **404 NOT_FOUND** (kein Leak).
- **Workflow:** DB → API → UI → Tests/Proof → Schlussrapport → Commit/Push
- **Prisma v7 Policy:** Connection URLs (z. B. `DATABASE_URL`) sind **nicht** im `schema.prisma`,
  sondern in `prisma.config.ts` konfiguriert.

## Core Domain Models (TP 1.0)

Dieses Teilprojekt ergänzt das DB-Fundament um die GoLive-Core Entities:

- **Form** + **FormField**
- **Lead** + **LeadAttachment**
- **ExportJob**

### Enums

- `FormStatus`: `DRAFT | ACTIVE | ARCHIVED`
- `FieldType` (minimal start, erweiterbar):
  `TEXT | TEXTAREA | SINGLE_SELECT | MULTI_SELECT | EMAIL | PHONE`
- `AttachmentType`: `IMAGE | PDF | OTHER`
- `ExportJobStatus`: `QUEUED | RUNNING | DONE | FAILED`
- `ExportJobType`: `CSV` (später erweiterbar)

### Form

Felder (minimal robust):

- `id` (cuid), `tenantId` (FK)
- `name`, `description?`
- `status` (FormStatus)
- `config?` (Json)
- `createdAt`, `updatedAt`

Relationen:

- `fields[]`, `leads[]`

Indizes:

- `@@index([tenantId, status])`

### FormField

Felder:

- `id`, `tenantId`, `formId`
- `key` (stabiler Identifier), `label`, `type` (FieldType)
- `required`, `isActive`, `sortOrder`
- `placeholder?`, `helpText?`, `config?` (Json)
- `createdAt`, `updatedAt`

Constraints / Indizes:

- Unique: `@@unique([formId, key])` (stabil, pro Form eindeutig)
- Index: `@@index([tenantId, formId, isActive, sortOrder])`

### Lead (inkl. Idempotency + Soft-delete vorbereitet)

Felder:

- `id`, `tenantId`, `formId`
- `clientLeadId` (String, idempotency key)
- `capturedAt`
- `values` (Json), `meta?` (Json)

Idempotency:

- Unique: `@@unique([tenantId, clientLeadId])`
  - verhindert Doppelposts bei Retry (Mobile/Online-first).

Soft-delete Vorbereitung:

- `isDeleted` (default false)
- `deletedAt?`, `deletedReason?`, `deletedByUserId?`

Index:

- `@@index([tenantId, formId, capturedAt])`

### LeadAttachment

Felder:

- `id`, `tenantId`, `leadId`
- `type` (AttachmentType)
- `filename`, `mimeType`, `sizeBytes`
- `storageKey?` (später Object Storage)
- `createdAt`, `updatedAt`

Index:

- `@@index([tenantId, leadId])`

### ExportJob

Felder:

- `id`, `tenantId`
- `type` (ExportJobType), `status` (ExportJobStatus)
- `params?` (Json)
- `resultStorageKey?`
- `queuedAt`, `startedAt?`, `finishedAt?`, `updatedAt`

Index:

- `@@index([tenantId, status, updatedAt])`

## Migration-Strategie

- Prisma Migrate ist die einzige Quelle der Wahrheit.
- Jede Schema-Änderung ⇒ neue Migration.
- Seed ist **idempotent** und darf mehrfach laufen (keine Duplikate).

